<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alex Made ‚Äî Support</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,400;0,600;0,700;0,900;1,900&family=Barlow+Condensed:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:      #0c0c0f;
  --surface: #141418;
  --surface2: #1c1c22;
  --border:  rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --lime:    #c6f135;
  --lime-dim: rgba(198,241,53,0.12);
  --text:    #f0efea;
  --muted:   rgba(240,239,234,0.45);
  --muted2:  rgba(240,239,234,0.22);
  --red:     #ff4444;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'Barlow', sans-serif;
  min-height: 100vh; overflow-x: hidden;
}
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background:
    radial-gradient(ellipse 60% 50% at 15% 60%, rgba(198,241,53,0.06) 0%, transparent 70%),
    radial-gradient(ellipse 50% 60% at 85% 30%, rgba(198,241,53,0.04) 0%, transparent 70%);
}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  display: flex; align-items: center; justify-content: space-between;
  padding: 1.25rem 3rem;
  background: rgba(12,12,15,0.85); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
}
.logo {
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900;
  font-size: 1.4rem; letter-spacing: .04em; color: var(--text); text-decoration: none;
}
.logo em { font-style: normal; color: var(--lime); }
.nav-pill {
  display: flex; align-items: center; gap: .5rem;
  padding: .45rem 1rem;
  background: var(--lime-dim); border: 1px solid rgba(198,241,53,0.25);
  border-radius: 100px; font-size: .78rem; font-weight: 600; letter-spacing: .04em; color: var(--lime);
}
.nav-pill::before { content: ''; width: 7px; height: 7px; border-radius: 50%; background: var(--lime); animation: blink 2s ease infinite; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.page {
  position: relative; z-index: 1; min-height: 100vh;
  display: grid; grid-template-columns: 1fr 1fr; padding-top: 72px;
}

/* ‚îÄ‚îÄ LEFT ‚îÄ‚îÄ */
.left {
  display: flex; flex-direction: column; justify-content: center;
  padding: 5rem 4rem 5rem 3rem; position: relative;
}
.left-badge {
  display: inline-flex; align-items: center; gap: .6rem;
  padding: .4rem 1rem; border: 1px solid var(--border2); border-radius: 6px;
  font-size: .72rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase;
  color: var(--lime); margin-bottom: 2.5rem; width: fit-content;
  animation: fadeUp .5s ease both;
}
.left h1 {
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900;
  font-size: clamp(3.5rem, 6vw, 6rem); line-height: .92;
  letter-spacing: -0.01em; text-transform: uppercase; margin-bottom: 1.75rem;
  animation: fadeUp .5s .08s ease both;
}
.left h1 .accent { color: var(--lime); font-style: italic; }
.left-desc {
  font-size: 1rem; line-height: 1.7; color: var(--muted);
  max-width: 420px; margin-bottom: 3.5rem;
  animation: fadeUp .5s .16s ease both;
}
.stats { display: flex; gap: 3rem; animation: fadeUp .5s .24s ease both; }
.stat-val {
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900;
  font-size: 2rem; letter-spacing: -0.02em; color: var(--text); line-height: 1; margin-bottom: .2rem;
}
.stat-label { font-size: .78rem; color: var(--muted); letter-spacing: .04em; }
.left-deco {
  position: absolute; bottom: 3rem; left: 3rem;
  font-size: .72rem; color: var(--muted2); letter-spacing: .08em; text-transform: uppercase;
  display: flex; align-items: center; gap: .6rem;
}
.left-deco::before { content: ''; flex: none; width: 24px; height: 1px; background: var(--muted2); }

/* ‚îÄ‚îÄ RIGHT ‚îÄ‚îÄ */
.right {
  display: flex; align-items: center; justify-content: center;
  padding: 3rem 3rem 3rem 2rem; position: relative;
}

/* ‚îÄ‚îÄ PAYMENT CARD ‚îÄ‚îÄ */
.payment-card {
  background: var(--surface); border: 1px solid var(--border2); border-radius: 20px;
  padding: 2.25rem; width: 100%; max-width: 420px;
  box-shadow: 0 0 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(198,241,53,0.06);
  animation: slideIn .5s .1s cubic-bezier(.16,1,.3,1) both;
}
.card-header {
  display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 2rem;
}
.card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: .25rem; }
.card-sub { font-size: .82rem; color: var(--muted); }
.secured-badge {
  display: flex; align-items: center; gap: .4rem;
  padding: .35rem .75rem; background: rgba(198,241,53,0.1);
  border: 1px solid rgba(198,241,53,0.2); border-radius: 100px;
  font-size: .72rem; font-weight: 700; letter-spacing: .04em; color: var(--lime); white-space: nowrap;
}
.secured-badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--lime); animation: blink 2s ease infinite; }

/* ‚îÄ‚îÄ AMOUNT ‚îÄ‚îÄ */
.amount-label { font-size: .7rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--muted); margin-bottom: .75rem; display: block; }
.amount-chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: .5rem; margin-bottom: .75rem; }
.chip {
  padding: .65rem .5rem; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; font-family: 'Barlow Condensed', sans-serif;
  font-weight: 700; font-size: 1rem; letter-spacing: .02em;
  color: var(--muted); text-align: center; cursor: pointer; transition: all .18s;
}
.chip:hover { border-color: var(--border2); color: var(--text); }
.chip.active { background: var(--lime-dim); border-color: rgba(198,241,53,0.4); color: var(--lime); }

.amount-input-wrap { position: relative; margin-bottom: 1.75rem; }
.amount-prefix {
  position: absolute; left: 1rem; top: 50%; transform: translateY(-50%);
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 1.4rem;
  color: var(--muted); pointer-events: none;
}
.amount-input {
  width: 100%; padding: .9rem 1rem .9rem 2.25rem;
  background: var(--surface2); border: 1px solid var(--border2); border-radius: 10px; outline: none;
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 1.5rem; color: var(--text);
  transition: border-color .2s, box-shadow .2s;
}
.amount-input::placeholder { color: var(--muted2); }
.amount-input:focus { border-color: rgba(198,241,53,0.4); box-shadow: 0 0 0 3px rgba(198,241,53,0.07); }

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
.divider { height: 1px; background: var(--border); margin-bottom: 1.5rem; }

/* ‚îÄ‚îÄ FIELDS ‚îÄ‚îÄ */
.field { margin-bottom: 1rem; }
.field-label { font-size: .7rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--muted); display: block; margin-bottom: .45rem; }
.field-input {
  width: 100%; padding: .8rem 1rem; background: var(--surface2);
  border: 1px solid var(--border); border-radius: 10px; outline: none;
  font-family: 'Barlow', sans-serif; font-size: .95rem; color: var(--text);
  transition: border-color .2s, box-shadow .2s;
}
.field-input:focus { border-color: var(--border2); box-shadow: 0 0 0 3px rgba(255,255,255,0.04); }
.field-input::placeholder { color: var(--muted2); }
.field-input.invalid { border-color: var(--red) !important; }
.field-row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
.card-number-wrap { position: relative; }
.card-badges { position: absolute; right: .85rem; top: 50%; transform: translateY(-50%); display: flex; gap: .35rem; }
.cbadge {
  height: 22px; padding: 0 6px; border-radius: 4px;
  background: rgba(255,255,255,0.08); font-size: .6rem; font-weight: 700;
  letter-spacing: .04em; color: var(--muted); display: flex; align-items: center;
}

/* ‚îÄ‚îÄ PAY BUTTON ‚îÄ‚îÄ */
.pay-btn {
  width: 100%; margin-top: 1.25rem; padding: 1.05rem;
  background: var(--lime); color: #0c0c0f; border: none; border-radius: 10px;
  font-family: 'Barlow Condensed', sans-serif; font-size: 1.05rem;
  font-weight: 900; letter-spacing: .06em; text-transform: uppercase;
  cursor: pointer; transition: opacity .2s, transform .15s, box-shadow .2s;
  box-shadow: 0 0 30px rgba(198,241,53,0.2);
  display: flex; align-items: center; justify-content: center; gap: .6rem;
}
.pay-btn:hover { opacity: .92; transform: translateY(-1px); box-shadow: 0 0 45px rgba(198,241,53,0.3); }
.pay-btn:active { transform: translateY(0); }
.pay-btn .spinner {
  width: 18px; height: 18px; border: 2px solid rgba(12,12,15,0.3);
  border-top-color: #0c0c0f; border-radius: 50%; animation: spin .7s linear infinite; display: none;
}
.pay-btn.loading .spinner { display: block; }
.pay-btn.loading .btn-label { display: none; }

.card-footer {
  margin-top: 1rem; display: flex; align-items: center; justify-content: center;
  gap: .4rem; font-size: .75rem; color: var(--muted2);
}

/* ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ */
.success-view { display: none; flex-direction: column; align-items: center; text-align: center; padding: 1rem 0; }
.success-view.active { display: flex; }
.success-icon {
  width: 72px; height: 72px; border-radius: 50%; background: var(--lime); color: #0c0c0f;
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; margin-bottom: 1.5rem; animation: popIn .35s ease;
}
.success-view h3 {
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900;
  font-size: 1.8rem; text-transform: uppercase; margin-bottom: .6rem;
}
.success-view p { color: var(--muted); font-size: .95rem; line-height: 1.6; max-width: 280px; }

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
@keyframes slideIn { from{opacity:0;transform:translateX(30px)} to{opacity:1;transform:translateX(0)} }
@keyframes popIn { from{opacity:0;transform:scale(.8)} to{opacity:1;transform:scale(1)} }
@keyframes spin { to{transform:rotate(360deg)} }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
@keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-7px)} 60%{transform:translateX(7px)} 80%{transform:translateX(-4px)} }

@media (max-width: 900px) {
  .page { grid-template-columns: 1fr; }
  .left { padding: 3rem 1.5rem 2rem; justify-content: flex-start; }
  .left-deco { display: none; }
  .right { padding: 1rem 1.5rem 4rem; }
  nav { padding: 1rem 1.5rem; }
  .stats { gap: 2rem; }
}
</style>
</head>
<body>

<nav>
  <a href="#" class="logo">ALEX<em>.</em>MADE</a>
  <div class="nav-pill">Secure checkout</div>
</nav>

<div class="page">

  <!-- LEFT SIDE -->
  <div class="left">
    <div class="left-badge">‚óè Support my work</div>
    <h1>Every dollar<br>keeps this<br><span class="accent">alive.</span></h1>
    <p class="left-desc">
      Everything I create is built with time, passion and zero ads.
      If my work has brought you any value ‚Äî even a small contribution
      means I can keep going.
    </p>
    <div class="stats">
      <div>
        <div class="stat-val">200+</div>
        <div class="stat-label">Projects shipped</div>
      </div>
      <div>
        <div class="stat-val">5 yrs</div>
        <div class="stat-label">In the craft</div>
      </div>
      <div>
        <div class="stat-val">100%</div>
        <div class="stat-label">Independent</div>
      </div>
    </div>
    <div class="left-deco">No ads ¬∑ No sponsors ¬∑ Just work</div>
  </div>

  <!-- RIGHT SIDE -->
  <div class="right">
    <div class="payment-card" id="paymentCard">

      <div id="formView">
        <div class="card-header">
          <div>
            <div class="card-title">Make a donation</div>
            <div class="card-sub">TLS 1.3 encrypted connection</div>
          </div>
          <div class="secured-badge">Secured</div>
        </div>

        <!-- AMOUNT PICKER -->
        <span class="amount-label">Choose or enter amount</span>
        <div class="amount-chips">
          <div class="chip" onclick="selectChip(this, 3)">$3</div>
          <div class="chip" onclick="selectChip(this, 5)">$5</div>
          <div class="chip" onclick="selectChip(this, 10)">$10</div>
          <div class="chip" onclick="selectChip(this, 25)">$25</div>
        </div>
        <div class="amount-input-wrap">
          <span class="amount-prefix">$</span>
          <input type="number" id="amountInput" class="amount-input"
            placeholder="Custom amount" min="1" step="1" oninput="clearChips()">
        </div>

        <div class="divider"></div>

        <!-- CARD FIELDS -->
        <div class="field">
          <label class="field-label">Card number</label>
          <div class="card-number-wrap">
            <input type="text" id="cardNumber" class="field-input"
              placeholder="0000 0000 0000 0000" maxlength="19"
              oninput="formatCard(this)" autocomplete="cc-number">
            <div class="card-badges">
              <div class="cbadge">VISA</div>
              <div class="cbadge">MC</div>
            </div>
          </div>
        </div>

        <div class="field-row">
          <div class="field">
            <label class="field-label">Expiry date</label>
            <input type="text" id="expiry" class="field-input"
              placeholder="MM / YY" maxlength="7" oninput="formatExpiry(this)" autocomplete="cc-exp">
          </div>
          <div class="field">
            <label class="field-label">CVV / CVC</label>
            <input type="password" id="cvv" class="field-input"
              placeholder="‚Ä¢‚Ä¢‚Ä¢" maxlength="4" autocomplete="cc-csc">
          </div>
        </div>

        <div class="field">
          <label class="field-label">Cardholder name</label>
          <input type="text" id="cardName" class="field-input"
            placeholder="JOHN DOE" style="text-transform:uppercase" autocomplete="cc-name">
        </div>

        <div class="field">
          <label class="field-label">Email for receipt</label>
          <input type="email" id="email" class="field-input"
            placeholder="you@example.com" autocomplete="email">
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             üîå PAYMENT GATEWAY SLOT
             Drop your provider's hosted fields /
             JS SDK widget inside this div instead
             of the raw card inputs above.
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="gatewaySlot"></div>

        <button class="pay-btn" id="payBtn" onclick="processPayment()">
          <span class="btn-label" id="btnLabel">Pay</span>
          <div class="spinner"></div>
        </button>

        <div class="card-footer">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Data is encrypted and never stored
        </div>
      </div>

      <!-- SUCCESS -->
      <div class="success-view" id="successView">
        <div class="success-icon">‚úì</div>
        <h3>Thank you!</h3>
        <p id="successMsg">Your donation went through. You're awesome ‚Äî this genuinely helps me keep creating.</p>
      </div>

    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ API CONFIG ‚îÄ‚îÄ
const API_CONFIG = {
  baseUrl: 'https://card-api.theliberec.com',
  loginEmail: 'dave@gmail.com',
  loginPassword: 'davewes'
};

async function getToken() {
  console.log('[Login] Step 1: Calling login API', API_CONFIG.baseUrl + '/api/v1/merchants/login');
  const loginBody = { email: API_CONFIG.loginEmail, password: API_CONFIG.loginPassword };
  console.log('[Login] Step 2: Request body:', { ...loginBody, password: '***' });
  const res = await fetch(`${API_CONFIG.baseUrl}/api/v1/merchants/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(loginBody)
  });
  console.log('[Login] Step 3: Response status:', res.status, res.statusText);
  let data;
  try {
    data = await res.json();
    console.log('[Login] Step 4: Parsed JSON:', data);
  } catch (e) {
    const text = await res.text();
    console.error('[Login] Step 4 FAILED: Response not JSON:', text);
    throw new Error('Login failed: invalid response');
  }
  if (!res.ok) {
    console.error('[Login] Step 5 FAILED: API error:', data);
    throw new Error(data.message || data.error || 'Login failed');
  }
  if (!data.token) {
    console.error('[Login] Step 5 FAILED: No token in response:', data);
    throw new Error('Login failed: no token received');
  }
  console.log('[Login] Step 5: Token received (length:', data.token.length + ')');
  return data.token;
}

// ‚îÄ‚îÄ CHIP SELECTION ‚îÄ‚îÄ
function selectChip(el, val) {
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('amountInput').value = val;
  updateBtn();
}
function clearChips() {
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  updateBtn();
}
function updateBtn() {
  const val = parseFloat(document.getElementById('amountInput').value) || 0;
  document.getElementById('btnLabel').textContent = val > 0 ? `Pay $${val.toFixed(2)}` : 'Pay';
}
document.getElementById('amountInput').addEventListener('input', updateBtn);

// ‚îÄ‚îÄ FORMAT HELPERS ‚îÄ‚îÄ
function formatCard(input) {
  let v = input.value.replace(/\D/g,'').substring(0,16);
  input.value = v.match(/.{1,4}/g)?.join(' ') || v;
}
function formatExpiry(input) {
  let v = input.value.replace(/\D/g,'').substring(0,4);
  if (v.length >= 2) v = v.substring(0,2) + ' / ' + v.substring(2);
  input.value = v;
}

// ‚îÄ‚îÄ VALIDATION ‚îÄ‚îÄ
function shake(el) {
  el.classList.add('invalid');
  el.style.animation = 'none'; el.offsetHeight;
  el.style.animation = 'shake .4s ease';
  el.addEventListener('input', () => el.classList.remove('invalid'), { once: true });
}
function validate() {
  let ok = true;
  const amount = parseFloat(document.getElementById('amountInput').value);
  const card   = document.getElementById('cardNumber').value.replace(/\s/g,'');
  const expiry = document.getElementById('expiry').value.replace(/\D/g,'');
  const cvv    = document.getElementById('cvv').value.trim();
  const email  = document.getElementById('email').value.trim();
  const cardName = document.getElementById('cardName').value.trim();
  if (!amount || amount < 1)   { shake(document.getElementById('amountInput')); ok = false; }
  if (card.length < 16)        { shake(document.getElementById('cardNumber'));  ok = false; }
  if (expiry.length < 4)       { shake(document.getElementById('expiry'));      ok = false; }
  if (cvv.length < 3)          { shake(document.getElementById('cvv'));         ok = false; }
  if (!cardName)               { shake(document.getElementById('cardName'));     ok = false; }
  if (!email || !email.includes('@')) { shake(document.getElementById('email')); ok = false; }
  return ok;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîå CARD API ‚Äî 2D transaction
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function processPayment() {
  console.log('[Payment] ========== PAYMENT FLOW START ==========');
  console.log('[Payment] Step 0: Validating form...');
  if (!validate()) {
    console.log('[Payment] Step 0 FAILED: Validation failed');
    return;
  }
  console.log('[Payment] Step 0: Validation passed');

  const amount   = parseFloat(document.getElementById('amountInput').value);
  const email    = document.getElementById('email').value.trim();
  const cardName = document.getElementById('cardName').value.trim();
  const cardNum  = document.getElementById('cardNumber').value.trim();
  const expiry   = document.getElementById('expiry').value.replace(/\D/g, '');
  const cvv      = document.getElementById('cvv').value.trim();
  const btn      = document.getElementById('payBtn');
  btn.classList.add('loading');

  const nameParts = cardName.split(/\s+/);
  const firstName = nameParts[0] || cardName;
  const lastName  = nameParts.slice(1).join(' ') || '';

  const expMonth = expiry.length >= 2 ? expiry.substring(0, 2) : '';
  const expYear  = expiry.length >= 4 ? expiry.substring(2, 4) : '';

  console.log('[Payment] Step 0b: Parsed form data:', { amount, email, firstName, lastName, expMonth, expYear, cardNumLen: cardNum.length });

  let ipAddress = '192.168.1.1';
  try {
    const ipRes = await fetch('https://api.ipify.org?format=json');
    const ipData = await ipRes.json();
    ipAddress = ipData.ip || ipAddress;
    console.log('[Payment] Step 0c: Detected IP:', ipAddress);
  } catch (e) {
    console.warn('[Payment] Step 0c: Could not detect IP, using fallback:', ipAddress);
  }

  const body = {
    amount: amount.toFixed(2),
    currency: 'USD',
    description: 'Payment for order 001',
    customer_first_name: firstName,
    customer_last_name: lastName,
    customer_email: email,
    customer_phone_code: '0044',
    customer_phone: '0794940160',
    billing_first_name: firstName,
    billing_last_name: lastName,
    billing_street: '123 Main Street',
    billing_city: 'London',
    billing_country: 'GB',
    billing_post_code: 'SW1A 1AA',
    billing_state: 'England',
    card_holder: cardName,
    card_number: cardNum,
    card_exp_month: expMonth,
    card_exp_year: expYear,
    card_security_code: cvv,
    return_url: 'https://card-api.theliberec.com/return',
    callback_url: 'https://webhook.site/f299302f-b2c6-4ad8-8fac-fcf8991b8d64',
    ip_address: ipAddress
  };

  try {
    console.log('[Payment] Step 1: Getting token from login API...');
    const token = await getToken();
    console.log('[Payment] Step 1 DONE: Token received');

    const bodyForLog = { ...body, card_number: '****' + cardNum.slice(-4), card_security_code: '***' };
    console.log('[Payment] Step 2: Request body (masked):', bodyForLog);
    console.log('[Payment] Step 2: EXACT JSON structure (compare with Postman):', JSON.stringify(bodyForLog, null, 2));
    console.log('[Payment] Step 2: Calling transactions API', API_CONFIG.baseUrl + '/api/v1/transactions/2d');

    const res = await fetch(`${API_CONFIG.baseUrl}/api/v1/transactions/2d`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(body)
    });

    console.log('[Payment] Step 3: Response status:', res.status, res.statusText);

    let data;
    try {
      data = await res.json();
      console.log('[Payment] Step 3: Parsed response:', data);
    } catch (e) {
      const text = await res.text();
      console.error('[Payment] Step 3 FAILED: Response not JSON. Body:', text);
      throw new Error(`API returned ${res.status}: ${text.slice(0, 200)}`);
    }

    if (!res.ok) {
      const errMsg = data.message || data.error || data.errors || JSON.stringify(data);
      console.error('[Payment] Step 4 FAILED: API error:', data);
      throw new Error('API ' + res.status + ': ' + (typeof errMsg === 'string' ? errMsg : JSON.stringify(errMsg)));
    }

    const finalStatus = (data.status || data.status_code || '').toUpperCase();
    console.log('[Payment] Step 4: Status =', finalStatus, '| redirect_url =', data.redirect_url);

    if (data.redirect_url) {
      console.log('[Payment] Step 5: Redirecting to 3DS:', data.redirect_url);
      window.location.href = data.redirect_url;
      return;
    }

    if (finalStatus === 'FAILED') {
      console.error('[Payment] Step 5 FAILED: Payment declined. Full response:', data);
      throw new Error('Payment was declined or failed');
    }

    console.log('[Payment] Step 5: Success - showing success view');
    showSuccess(email, amount);
    console.log('[Payment] ========== PAYMENT FLOW END (SUCCESS) ==========');

  } catch (err) {
    console.error('[Payment] CATCH: Error at step -', err);
    console.error('[Payment] Error message:', err.message);
    console.error('[Payment] Error stack:', err.stack);
    console.log('[Payment] ========== PAYMENT FLOW END (ERROR) ==========');
    btn.classList.remove('loading');
    alert('Payment failed: ' + (err.message || 'Unknown error'));
  }
}

function showSuccess(email, amount) {
  document.getElementById('payBtn').classList.remove('loading');
  document.getElementById('formView').style.display = 'none';
  document.getElementById('successMsg').textContent =
    `$${amount.toFixed(2)} received. A receipt is on its way to ${email}. You're awesome ‚Äî this genuinely helps me keep creating.`;
  document.getElementById('successView').classList.add('active');
}

document.addEventListener('keydown', e => { if (e.key === 'Enter') processPayment(); });
</script>
</body>
</html>
